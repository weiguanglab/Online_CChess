# 中国象棋在线对战游戏 🏁

一个基于 Flask-SocketIO 的中国象棋在线对战游戏，支持多人实时对战。

## 📋 功能特性

- 🎮 完整的中国象棋规则实现
- 🌐 在线实时对战
- 👥 多房间支持，支持观众模式
- 🎯 移动验证和智能提示
- 🏆 游戏状态检测（将军、胜负判定）
- 📱 响应式网页界面
- 💬 实时聊天系统
- ⏱️ 服务器同步计时器（每回合2分钟）
- 🔄 棋盘自动翻转（黑方视角）
- ✅ 游戏开始前确认机制
- 🎨 视觉指示器（上一步移动、将军状态）
- 👀 观众观战功能

## 🛠️ 技术栈

- **后端**: Python Flask + Flask-SocketIO
- **前端**: HTML + CSS + JavaScript + Socket.IO
- **实时通信**: WebSocket
- **架构**: 面向对象设计，模块化开发
- **线程管理**: Python Threading（服务器端计时器）
- **状态同步**: 服务器端状态管理，客户端实时同步

## 📦 项目结构

```
CChess/
├── main.py              # 主程序入口
├── requirements.txt     # 依赖包列表
├── README.md           # 项目说明
├── .gitignore          # Git忽略文件
├── src/                # 源代码目录
│   ├── __init__.py     # 包初始化
│   ├── board.py        # 棋盘类
│   ├── move.py         # 移动验证和执行
│   ├── check.py        # 游戏状态检查
│   ├── game.py         # 游戏管理
│   └── server.py       # 服务器和路由
└── templates/          # HTML模板
    └── index.html      # 游戏界面
```

## 🚀 快速开始

### 环境要求

- Python 3.8+
- pip

### 安装步骤

1. **克隆项目**
   ```bash
   git clone https://github.com/weiguanglab/Online_CChess.git
   cd Online_CChess
   ```

2. **安装依赖**
   ```bash
   conda create -n online_cchess python=3.12
   conda activate online_cchess
   pip install -r requirements.txt
   ```

3. **启动服务器**
   ```bash
   python main.py
   ```

4. **开始游戏**

   打开浏览器访问: `http://localhost:5000`

   **多人游戏设置:**
   - 局域网内其他设备访问: `http://<你的IP地址>:5000`
   - 查看本机IP: `ipconfig`(Windows) 或 `ifconfig`(Linux/Mac)

## 🖼️ 界面预览

### 主要功能界面
- **游戏棋盘**: 中央位置的象棋棋盘，支持点击移动
- **聊天系统**: 左侧固定聊天框，支持实时交流
- **计时器**: 右下角显示当前回合剩余时间
- **确认对话框**: 游戏开始前的准备确认界面
- **状态显示**: 显示当前回合、玩家角色等信息

### 视觉特效
- 🟢 **绿色边框**: 标记上一步移动的起点和终点
- 🔴 **红色边框**: 标记将军状态的威胁棋子和被威胁的将帅
- 🟡 **黄色高亮**: 选中的棋子
- 🟢 **绿色高亮**: 可移动的目标位置

## 🎮 游戏流程

1. **加入房间**: 输入房间号加入游戏
2. **角色分配**: 前两名玩家自动分配红方/黑方，后续玩家成为观众
3. **确认准备**: 双方玩家点击"确认准备"按钮
4. **开始对战**: 确认后游戏开始，计时器启动
5. **实时聊天**: 使用左侧聊天框与其他玩家交流
6. **观战功能**: 观众可以观看比赛并参与聊天

## 🎯 游戏规则

### 基本规则
- 红方先行，双方轮流移动
- 每回合限时2分钟，超时判负
- 将死或超时对方获胜
- 飞将（将帅照面）可直接吃掉对方

### 特色功能
- **智能提示**: 选中棋子后高亮显示可移动位置
- **视觉指示**:
  - 绿色方框标记上一步移动
  - 红色方框标记将军状态
- **棋盘翻转**: 黑方玩家看到翻转的棋盘视角
- **实时聊天**: 支持玩家和观众实时交流
- **观众模式**: 房间满员后自动成为观众

### 棋子移动规则
- **将/帅**: 只能在九宫格内移动一格
- **士/仕**: 只能在九宫格内斜走
- **象/相**: 走田字，不能过河，不能塞象眼
- **马/傌**: 走日字，不能蹩马腿
- **车/俥**: 横竖直线移动
- **炮/砲**: 移动时同车，吃子时需隔一子
- **兵/卒**: 只能向前，过河后可左右移动

## 🏗️ 架构设计

### 核心类

1. **ChessBoard**: 棋盘管理
   - 棋盘初始化
   - 棋子位置管理
   - 棋子类型判断

2. **MoveValidator**: 移动验证
   - 各种棋子的移动规则
   - 移动合法性检查

3. **MoveExecutor**: 移动执行
   - 执行合法移动
   - 更新棋盘状态

4. **GameChecker**: 游戏状态检查
   - 检查游戏是否结束
   - 判断胜负条件

5. **ChessGame**: 游戏管理
   - 玩家管理
   - 回合控制
   - 游戏流程

6. **ChessServer**: 服务器管理
   - WebSocket事件处理
   - 房间管理
   - 客户端通信
   - 计时器回调处理

### 新增特性

7. **聊天系统**: 实时消息广播
8. **观众系统**: 支持多人观战
9. **计时器系统**: 服务器端同步计时
10. **确认机制**: 游戏开始前双方确认
11. **视觉效果**: 移动指示和状态标记

## 🔧 开发说明

### 添加新功能

1. 在相应的模块中添加功能
2. 更新 `__init__.py` 中的导出
3. 在服务器类中添加对应的事件处理

### 自定义规则

可以在 `MoveValidator` 类中修改各种棋子的移动规则。

### 技术细节

**服务器端计时器**:
- 使用Python threading实现后台计时
- 通过SocketIO回调机制同步到所有客户端
- 避免客户端计时器不同步问题

**状态管理**:
- 服务器端维护权威游戏状态
- 客户端仅负责UI渲染和用户交互
- 所有游戏逻辑在服务器端验证

**实时通信**:
- WebSocket确保低延迟实时通信
- 房间隔离，消息定向广播
- 支持多种事件类型（移动、聊天、计时等）

## 🐛 常见问题

**Q: 无法连接到服务器？**
A: 检查防火墙设置，确保 5000 端口可访问。

**Q: 移动无效？**
A: 检查是否轮到你的回合，移动是否符合象棋规则。

**Q: 房间已满？**
A: 每个房间支持2名玩家对战，其余自动成为观众。

**Q: 计时器不同步？**
A: 计时器由服务器统一管理，如有问题请刷新页面重新加入。

**Q: 聊天消息发送失败？**
A: 检查网络连接，确保与服务器的WebSocket连接正常。

**Q: 确认按钮无响应？**
A: 确保你是红方或黑方玩家（非观众），且尚未确认过。

## 📝 更新日志

### v2.0.0 (2025-05-29)
- ✨ 新增实时聊天功能
- 👥 支持观众观战模式
- ⏱️ 服务器端同步计时器系统
- 🔄 黑方棋盘自动翻转
- ✅ 游戏开始前确认机制
- 🎨 添加移动指示和将军状态视觉效果
- 🐛 修复多项稳定性问题

### v1.0.0 (2025-05-27)
- ✨ 初始版本发布
- 🎮 完整的象棋规则实现
- 🌐 在线对战功能
- 📱 Web界面

## 🎯 未来计划

- 🏆 排行榜系统
- 📊 游戏统计和回放功能
- 🤖 AI对战模式
- 🎵 音效和背景音乐
- 📱 移动端适配优化
- 🔐 用户注册和登录系统

## 🤝 贡献指南

1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 打开 Pull Request

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情。

## 👨‍💻 作者

- **Ethan** - *Initial work*

## 🙏 致谢

- 感谢所有贡献者
- 感谢开源社区的支持
